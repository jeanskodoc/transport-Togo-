<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TaxiTogo - Connexion Conducteur</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #006747; /* Vert togolais */
            --secondary: #FFCE00; /* Jaune togolais */
            --accent: #D21034; /* Rouge togolais */
            --success: #28a745;
            --warning: #ffc107;
            --info: #17a2b8;
            --light: #f5f5f5;
            --dark: #333333;
            --shadow: 0 2px 10px rgba(0,0,0,0.1);
            --radius: 8px;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background: linear-gradient(135deg, var(--primary), #004d36);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            width: 100%;
            max-width: 400px;
        }
        
        .login-card {
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
        }
        
        .login-header {
            background: var(--primary);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }
        
        .logo {
            font-size: 1.8rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 10px;
        }
        
        .logo-icon {
            margin-right: 10px;
            font-size: 2.2rem;
        }
        
        .login-subtitle {
            font-size: 1rem;
            opacity: 0.9;
        }
        
        .login-body {
            padding: 25px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--dark);
            font-size: 0.95rem;
        }
        
        .form-group input {
            width: 100%;
            padding: 14px 15px;
            border: 2px solid #e1e5e9;
            border-radius: var(--radius);
            font-size: 1rem;
            transition: all 0.3s;
            min-height: 48px;
        }
        
        .form-group input:focus {
            border-color: var(--secondary);
            outline: none;
            box-shadow: 0 0 0 3px rgba(255, 206, 0, 0.1);
        }
        
        .password-container {
            position: relative;
        }
        
        .toggle-password {
            position: absolute;
            right: 15px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #7f8c8d;
            cursor: pointer;
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: var(--radius);
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            min-height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--accent);
            color: white;
        }
        
        .btn-primary:hover, .btn-primary:active {
            background: #b00d2c;
            transform: translateY(-2px);
        }
        
        .login-footer {
            text-align: center;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #ecf0f1;
            font-size: 0.9rem;
        }
        
        .login-footer a {
            color: var(--primary);
            text-decoration: none;
            font-weight: 600;
        }
        
        .login-footer a:hover {
            text-decoration: underline;
        }
        
        .alert {
            padding: 12px 15px;
            border-radius: var(--radius);
            margin-bottom: 20px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .alert-error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }
        
        .alert-success {
            background: #efe;
            color: #363;
            border: 1px solid #cfc;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* Styles pour l'application principale */
        .app-container {
            width: 100%;
            max-width: 1200px;
            background: white;
            border-radius: var(--radius);
            box-shadow: var(--shadow);
            overflow: hidden;
            min-height: 90vh;
        }
        
        .app-header {
            background: linear-gradient(135deg, var(--primary), #004d36);
            color: white;
            padding: 1rem 0;
        }
        
        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }
        
        .driver-info {
            text-align: right;
        }
        
        .driver-name {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: var(--radius);
            cursor: pointer;
            margin-left: 15px;
            display: flex;
            align-items: center;
            gap: 5px;
            min-height: 44px;
        }
        
        .logout-btn:active {
            background: rgba(255,255,255,0.3);
        }
        
        .setup-form, .trip-card, .tracking-section, .payment-section, .receipts-section, .history-section {
            background: white;
            border-radius: var(--radius);
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            padding: 20px;
            margin: 20px;
        }
        
        .section-title {
            font-size: 1.3rem;
            color: var(--primary);
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid var(--light);
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-row {
            display: flex;
            flex-direction: column;
            gap: 0;
        }
        
        .form-row .form-group {
            flex: 1;
        }
        
        .info-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .info-card {
            background: var(--light);
            padding: 15px;
            border-radius: var(--radius);
            border-left: 4px solid var(--secondary);
        }
        
        .info-card h3 {
            margin-bottom: 10px;
            color: var(--primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background: var(--light);
            padding: 15px;
            border-radius: var(--radius);
            text-align: center;
        }
        
        .controls {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .btn-app {
            display: inline-flex;
            padding: 14px 20px;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            text-align: center;
            transition: all 0.3s;
            flex: 1;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
        }
        
        .btn-app:active {
            transform: translateY(-2px);
        }
        
        .btn-primary-app {
            background: var(--primary);
            color: white;
        }
        
        .btn-success-app {
            background: var(--success);
            color: white;
        }
        
        .btn-warning-app {
            background: var(--warning);
            color: var(--dark);
        }
        
        .btn-accent-app {
            background: var(--accent);
            color: white;
        }
        
        .btn-whatsapp-app {
            background: #25D366;
            color: white;
        }
        
        .btn:disabled {
            background: #bdc3c7;
            cursor: not-allowed;
            transform: none !important;
        }
        
        .receipt {
            background: #f8f9fa;
            border-radius: var(--radius);
            padding: 20px;
            margin-bottom: 20px;
            border: 2px dashed #dee2e6;
        }
        
        .receipt-title {
            text-align: center;
            font-size: 1.4rem;
            margin-bottom: 20px;
            color: var(--primary);
            font-weight: 700;
        }
        
        .receipt-details {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .receipt-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid #eee;
        }
        
        .receipt-total {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--success);
            border-top: 2px solid #dee2e6;
            padding-top: 10px;
            margin-top: 10px;
        }
        
        .filters {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .filter-group {
            flex: 1;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .filter-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: var(--radius);
            font-size: 1rem;
            min-height: 48px;
        }
        
        .receipts-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
        }
        
        .receipt-card {
            background: var(--light);
            border-radius: var(--radius);
            padding: 15px;
            border-left: 4px solid var(--secondary);
        }
        
        .receipt-card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }
        
        .receipt-card-date {
            font-weight: 600;
            color: var(--primary);
        }
        
        .receipt-card-amount {
            font-weight: 700;
            color: var(--success);
        }
        
        .receipt-card-details {
            font-size: 0.9rem;
            color: #666;
        }
        
        .receipt-card-details div {
            margin-bottom: 5px;
        }
        
        .history-item {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid #eee;
        }
        
        .history-item:last-child {
            border-bottom: none;
        }
        
        .history-time {
            font-weight: 600;
            color: var(--primary);
        }
        
        .history-action {
            color: #666;
        }
        
        .trip-header {
            background: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .trip-title {
            font-size: 1.2rem;
            font-weight: 600;
        }
        
        .trip-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .status-active {
            background: var(--success);
        }
        
        .status-paused {
            background: var(--warning);
        }
        
        .status-finished {
            background: var(--accent);
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            padding-bottom: 8px;
            border-bottom: 1px solid #ddd;
        }
        
        .info-item:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .info-label {
            font-weight: 600;
            color: #555;
        }
        
        .info-value {
            font-weight: 500;
        }
        
        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--primary);
            margin: 10px 0;
        }
        
        .stat-label {
            font-size: 0.9rem;
            color: #666;
        }
        
        .map-integration {
            background: #e8f4fd;
            border-radius: var(--radius);
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid var(--secondary);
        }
        
        .map-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .map-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: var(--radius);
            background: var(--primary);
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            min-height: 48px;
        }
        
        .map-btn:active {
            background: #004d36;
        }
        
        .map-btn-whatsapp {
            background: #25D366;
        }
        
        .map-btn-whatsapp:active {
            background: #128C7E;
        }
        
        .gps-status {
            padding: 12px;
            border-radius: var(--radius);
            margin-bottom: 15px;
            text-align: center;
            font-weight: 600;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        
        .gps-active {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .gps-inactive {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .gps-waiting {
            background-color: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            color: #7f8c8d;
            font-size: 0.9rem;
        }
        
        /* Styles pour les écrans plus larges */
        @media (min-width: 768px) {
            .form-row {
                flex-direction: row;
                gap: 15px;
            }
            
            .info-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
            
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            }
            
            .controls {
                flex-direction: row;
            }
            
            .map-buttons {
                flex-direction: row;
            }
            
            .filters {
                flex-direction: row;
            }
            
            .receipts-grid {
                grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            }
            
            .receipt-details {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }
        
        /* Améliorations pour Android */
        @media (max-width: 767px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            
            .driver-info {
                text-align: center;
                margin-top: 10px;
            }
            
            .logout-btn {
                margin-left: 0;
                margin-top: 10px;
            }
            
            .setup-form, .trip-card, .tracking-section, .payment-section, .receipts-section, .history-section {
                margin: 15px 10px;
                padding: 15px;
            }
            
            .section-title {
                font-size: 1.2rem;
            }
            
            .stat-value {
                font-size: 1.6rem;
            }
        }
        
        /* Optimisations pour le défilement sur Android */
        html {
            -webkit-overflow-scrolling: touch;
            scroll-behavior: smooth;
        }
        
        /* Éviter le zoom sur les champs de formulaire sur iOS */
        @media screen and (max-width: 767px) {
            input, select, textarea {
                font-size: 16px !important;
            }
        }
    </style>
</head>
    
<body>
    <!-- Écran de connexion -->
    <div class="container" id="login-container">
        <div class="login-card">
            <div class="login-header">
                <div class="logo">
                    <span class="logo-icon"><i class="fas fa-taxi"></i></span>
                    <span>TaxiTogo</span>
                </div>
                <div class="login-subtitle">Espace Conducteur</div>
            </div>
            <div class="login-body">
                <div id="login-alert" class="alert alert-error hidden">
                    <i class="fas fa-exclamation-circle"></i>
                    <span id="alert-message">Message d'erreur</span>
                </div>
                
                <form id="login-form">
                    <div class="form-group">
                        <label for="login-identifiant"><i class="fas fa-user"></i> Identifiant</label>
                        <input type="text" id="login-identifiant" placeholder="Votre identifiant" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="login-password"><i class="fas fa-lock"></i> Mot de passe</label>
                        <div class="password-container">
                            <input type="password" id="login-password" placeholder="Votre mot de passe" required>
                            <button type="button" class="toggle-password" id="toggle-password">
                                <i class="fas fa-eye"></i>
                            </button>
                        </div>
                    </div>
                    
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-sign-in-alt"></i> Se connecter
                    </button>
                </form>
                
                <div class="login-footer">
                    <p>Problème de connexion ? <a href="#" id="forgot-password">Contactez l'administrateur</a></p>
                </div>
            </div>
        </div>
    </div>

    <!-- Application principale (cachée au départ) -->
    <div class="app-container hidden" id="app-container">
        <div class="app-header">
            <div class="header-content">
                <div class="logo">
                    <span class="logo-icon"><i class="fas fa-taxi"></i></span>
                    <span>TaxiTogo</span>
                </div>
                <div class="driver-info">
                    <div class="driver-name" id="driver-name-display">Koffi Mensah</div>
                    <div id="driver-service-display">Taxi Moto • Lomé, Togo</div>
                    <button class="logout-btn" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Déconnexion
                    </button>
                </div>
            </div>
        </div>
        
        <div class="setup-form" id="setup-form">
            <h2 class="section-title"><i class="fas fa-cog"></i> Configuration du trajet</h2>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="driver-name"><i class="fas fa-id-card"></i> Nom du chauffeur</label>
                    <input type="text" id="driver-name" value="Koffi Mensah" readonly>
                </div>
                <div class="form-group">
                    <label for="service-type"><i class="fas fa-car"></i> Type de service</label>
                    <select id="service-type">
                        <option value="moto">Moto Taxi</option>
                        <option value="tricycle">Tricycle</option>
                        <option value="bagage">Taxi Bagage</option>
                        <option value="commun">Transport Commun</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="price-per-km"><i class="fas fa-tag"></i> Prix par km (FCFA)</label>
                    <input type="number" id="price-per-km" value="150" min="1">
                </div>
                <div class="form-group">
                    <label for="extra-fees-input"><i class="fas fa-plus-circle"></i> Frais supplémentaires (FCFA)</label>
                    <input type="number" id="extra-fees-input" value="200" min="0">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="client-name"><i class="fas fa-user"></i> Nom du client</label>
                    <input type="text" id="client-name" placeholder="Entrez le nom du client">
                </div>
                <div class="form-group">
                    <label for="client-phone"><i class="fas fa-phone"></i> Téléphone du client</label>
                    <input type="text" id="client-phone" placeholder="+22890123456">
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label for="start-address"><i class="fas fa-map-marker-alt"></i> Votre position actuelle</label>
                    <input type="text" id="start-address" value="Position GPS" readonly>
                </div>
                <div class="form-group">
                    <label for="end-address"><i class="fas fa-flag-checkered"></i> Adresse de destination</label>
                    <input type="text" id="end-address" placeholder="Université de Lomé, Lomé, Togo">
                </div>
            </div>
            
            <div class="controls">
                <button class="btn-app btn-primary-app" id="start-trip-btn">
                    <i class="fab fa-google"></i> Démarrer avec Google Maps
                </button>
            </div>
        </div>
        
        <div class="trip-card hidden" id="trip-card">
            <div class="trip-header">
                <div class="trip-title">Trajet en cours avec Google Maps</div>
                <div class="trip-status status-active" id="trip-status">ACTIF</div>
            </div>
            <div class="trip-body">
                <div class="info-grid">
                    <div class="info-card">
                        <h3><i class="fas fa-user"></i> Informations client</h3>
                        <div class="info-item">
                            <span class="info-label">Nom:</span>
                            <span class="info-value" id="client-name-display">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Téléphone:</span>
                            <span class="info-value" id="client-phone-display">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Type de service:</span>
                            <span class="info-value" id="service-type-display">-</span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h3><i class="fas fa-route"></i> Itinéraire Google Maps</h3>
                        <div class="info-item">
                            <span class="info-label">Départ:</span>
                            <span class="info-value" id="start-address-display">Position GPS</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Destination:</span>
                            <span class="info-value" id="end-address-display">-</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Distance estimée:</span>
                            <span class="info-value" id="estimated-distance">-- km</span>
                        </div>
                    </div>
                    
                    <div class="info-card">
                        <h3><i class="fas fa-clock"></i> Horaires</h3>
                        <div class="info-item">
                            <span class="info-label">Début du trajet:</span>
                            <span class="info-value" id="start-time">--:--</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Temps écoulé:</span>
                            <span class="info-value" id="elapsed-time">00:00:00</span>
                        </div>
                        <div class="info-item">
                            <span class="info-label">Date:</span>
                            <span class="info-value" id="current-date">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="tracking-section hidden" id="tracking-section">
            <h2 class="section-title"><i class="fab fa-google"></i> Navigation avec Google Maps Android</h2>
            
            <div class="map-integration">
                <h3><i class="fas fa-satellite-dish"></i> Intégration Google Maps</h3>
                <p>Utilisez l'application Google Maps de votre téléphone pour une navigation optimale</p>
                
                <div class="map-buttons">
                    <button class="map-btn" id="open-gmaps-navigation">
                        <i class="fab fa-google"></i> Ouvrir Navigation Google Maps
                    </button>
                    <button class="map-btn map-btn-whatsapp" id="share-location-btn">
                        <i class="fab fa-whatsapp"></i> Partager Position
                    </button>
                </div>
            </div>
            
            <div id="gps-status" class="gps-status gps-waiting">
                <i class="fas fa-satellite-dish"></i> En attente de connexion avec Google Maps...
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-label">Distance parcourue</div>
                    <div class="stat-value" id="distance-traveled">0.0 km</div>
                    <div class="stat-label" id="distance-progress">sur 0.0 km</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Vitesse moyenne</div>
                    <div class="stat-value" id="average-speed">0 km/h</div>
                    <div class="stat-label">en temps réel</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Temps écoulé</div>
                    <div class="stat-value" id="elapsed-time-display">00:00:00</div>
                    <div class="stat-label">depuis le départ</div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-label">Tarif actuel</div>
                    <div class="stat-value" id="current-fare">0 FCFA</div>
                    <div class="stat-label" id="price-per-km-display">0 FCFA/km</div>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn-app btn-primary-app" id="start-btn">
                    <i class="fas fa-play"></i> Démarrer le suivi
                </button>
                <button class="btn-app btn-warning-app" id="pause-btn" disabled>
                    <i class="fas fa-pause"></i> Pause
                </button>
                <button class="btn-app btn-accent-app" id="end-btn" disabled>
                    <i class="fas fa-stop"></i> Arriver à destination
                </button>
            </div>
        </div>
        
        <div class="payment-section hidden" id="payment-section">
            <h2 class="section-title"><i class="fas fa-money-bill-wave"></i> Reçu de paiement</h2>
            
            <div class="receipt">
                <div class="receipt-title">RECU DE TRANSPORT</div>
                
                <div class="receipt-details">
                    <div>
                        <div class="receipt-item">
                            <span>Chauffeur:</span>
                            <span id="receipt-driver">-</span>
                        </div>
                        <div class="receipt-item">
                            <span>Client:</span>
                            <span id="receipt-client">-</span>
                        </div>
                        <div class="receipt-item">
                            <span>Service:</span>
                            <span id="receipt-service">-</span>
                        </div>
                        <div class="receipt-item">
                            <span>Date:</span>
                            <span id="receipt-date">-</span>
                        </div>
                    </div>
                    
                    <div>
                        <div class="receipt-item">
                            <span>Départ:</span>
                            <span id="receipt-start">Position GPS</span>
                        </div>
                        <div class="receipt-item">
                            <span>Destination:</span>
                            <span id="receipt-end">-</span>
                        </div>
                        <div class="receipt-item">
                            <span>Distance parcourue:</span>
                            <span id="receipt-distance">0.0 km</span>
                        </div>
                        <div class="receipt-item">
                            <span>Durée:</span>
                            <span id="receipt-duration">00:00:00</span>
                        </div>
                    </div>
                </div>
                
                <div class="receipt-item">
                    <span>Tarif de base:</span>
                    <span id="receipt-base-fare">0 FCFA</span>
                </div>
                <div class="receipt-item">
                    <span>Frais supplémentaires:</span>
                    <span id="receipt-extra-fees">0 FCFA</span>
                </div>
                <div class="receipt-item receipt-total">
                    <span>TOTAL À PAYER:</span>
                    <span id="receipt-total">0 FCFA</span>
                </div>
            </div>
            
            <div class="controls">
                <button class="btn-app btn-success-app" id="payment-received-btn">
                    <i class="fas fa-check-circle"></i> Paiement reçu
                </button>
                <button class="btn-app btn-whatsapp-app" id="send-whatsapp-btn">
                    <i class="fab fa-whatsapp"></i> Envoyer par WhatsApp
                </button>
                <button class="btn-app btn-primary-app" id="print-receipt-btn">
                    <i class="fas fa-print"></i> Imprimer le reçu
                </button>
                <button class="btn-app btn-accent-app" id="new-trip-btn">
                    <i class="fas fa-plus"></i> Nouveau trajet
                </button>
            </div>
        </div>
        
        <div class="receipts-section hidden" id="receipts-section">
            <h2 class="section-title"><i class="fas fa-receipt"></i> Historique des reçus</h2>
            
            <div class="filters">
                <div class="filter-group">
                    <label for="filter-month"><i class="fas fa-calendar"></i> Mois</label>
                    <select id="filter-month">
                        <option value="all">Tous les mois</option>
                        <option value="01">Janvier</option>
                        <option value="02">Février</option>
                        <option value="03">Mars</option>
                        <option value="04">Avril</option>
                        <option value="05">Mai</option>
                        <option value="06">Juin</option>
                        <option value="07">Juillet</option>
                        <option value="08">Août</option>
                        <option value="09">Septembre</option>
                        <option value="10">Octobre</option>
                        <option value="11">Novembre</option>
                        <option value="12">Décembre</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-region"><i class="fas fa-map"></i> Région</label>
                    <select id="filter-region">
                        <option value="all">Toutes les régions</option>
                        <option value="maritime">Région Maritime</option>
                        <option value="plateaux">Région des Plateaux</option>
                        <option value="centrale">Région Centrale</option>
                        <option value="kara">Région de la Kara</option>
                        <option value="savanes">Région des Savanes</option>
                    </select>
                </div>
                
                <div class="filter-group">
                    <label for="filter-locality"><i class="fas fa-map-marker-alt"></i> Localité</label>
                    <select id="filter-locality">
                        <option value="all">Toutes les localités</option>
                        <option value="lome">Lomé</option>
                        <option value="kpalime">Kpalimé</option>
                        <option value="sokode">Sokodé</option>
                        <option value="kara">Kara</option>
                        <option value="dapaong">Dapaong</option>
                    </select>
                </div>
            </div>
            
            <div class="receipts-grid" id="receipts-grid">
                <!-- Les reçus sauvegardés seront affichés ici -->
            </div>
        </div>
        
        <div class="history-section hidden" id="history-section">
            <h2 class="section-title"><i class="fas fa-history"></i> Historique du trajet</h2>
            
            <div id="trip-history">
                <!-- L'historique sera généré dynamiquement -->
            </div>
        </div>
        
        <footer>
            <p>Compteur de trajet • TaxiTogo &copy; 2023</p>
            <p>Heure serveur: <span id="server-time">-</span></p>
        </footer>
    </div>

    <script>
        // Base de données des conducteurs (simulée)
        const driversDatabase = {
            "KOLA Maniwah": {
                id: "KOLA",
                password: "taxi123",
                name: "KOLA Maniwah",
                service: "Moto Taxi",
                region: "kara",
                phone: "+22893387595",
                vehicle: "Moto Yamaha 125",
                registration: "TG-123-AB",
                isActive: true
            },
            "ama.djondo": {
                id: "ama.djondo",
                password: "taxi456",
                name: "Ama Djondo",
                service: "Tricycle",
                region: "Kpalimé",
                phone: "+22890234567",
                vehicle: "Tricycle King",
                registration: "TG-456-CD",
                isActive: true
            },
            "komlan.agbeto": {
                id: "komlan.agbeto",
                password: "taxi789",
                name: "Komlan Agbeto",
                service: "Taxi Bagage",
                region: "Sokodé",
                phone: "+22890345678",
                vehicle: "Pickup Toyota",
                registration: "TG-789-EF",
                isActive: true
            },
            "afi.gbedema": {
                id: "afi.gbedema",
                password: "taxi000",
                name: "Afi Gbedema",
                service: "Transport Commun",
                region: "Kara",
                phone: "+22890456789",
                vehicle: "Toyota Corolla",
                registration: "TG-000-GH",
                isActive: true
            }
        };

        // Variables globales
        let currentDriver = null;
        let watchId = null;
        let currentPosition = null;
        let previousPosition = null;
        let totalDistance = 0;
        let tripStarted = false;
        let tripPaused = false;
        let startTime = null;
        let timerInterval = null;
        let elapsedSeconds = 0;
        let pricePerKm = 150;
        let extraFees = 200;
        let estimatedDistance = 0;
        let positionsHistory = [];
        let savedReceipts = JSON.parse(localStorage.getItem('savedReceipts')) || [];

        // Éléments DOM
        const loginContainer = document.getElementById('login-container');
        const appContainer = document.getElementById('app-container');
        const loginForm = document.getElementById('login-form');
        const loginAlert = document.getElementById('login-alert');
        const logoutBtn = document.getElementById('logout-btn');
        const togglePasswordBtn = document.getElementById('toggle-password');
        const loginPassword = document.getElementById('login-password');

        // Fonction pour afficher les messages d'alerte
        function showAlert(message, type = 'error') {
            if (!loginAlert) return;
            
            const alertMessage = document.getElementById('alert-message');
            if (alertMessage) {
                alertMessage.textContent = message;
            }
            
            loginAlert.className = `alert alert-${type}`;
            loginAlert.classList.remove('hidden');
            
            setTimeout(() => {
                loginAlert.classList.add('hidden');
            }, 5000);
        }

        // Fonction pour basculer la visibilité du mot de passe
        if (togglePasswordBtn && loginPassword) {
            togglePasswordBtn.addEventListener('click', function() {
                if (loginPassword.type === 'password') {
                    loginPassword.type = 'text';
                    togglePasswordBtn.innerHTML = '<i class="fas fa-eye-slash"></i>';
                } else {
                    loginPassword.type = 'password';
                    togglePasswordBtn.innerHTML = '<i class="fas fa-eye"></i>';
                }
            });
        }

        // Fonction de connexion
        if (loginForm) {
            loginForm.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const identifiant = document.getElementById('login-identifiant').value.trim();
                const password = document.getElementById('login-password').value;
                
                // Validation
                if (!identifiant || !password) {
                    showAlert('Veuillez remplir tous les champs');
                    return;
                }
                
                // Vérification dans la base de données
                if (driversDatabase[identifiant]) {
                    const driver = driversDatabase[identifiant];
                    
                    if (driver.password === password) {
                        if (driver.isActive) {
                            // Connexion réussie
                            currentDriver = driver;
                            initializeApp();
                        } else {
                            showAlert('Votre compte est désactivé. Contactez l\'administrateur.');
                        }
                    } else {
                        showAlert('Mot de passe incorrect');
                    }
                } else {
                    showAlert('Identifiant non reconnu');
                }
            });
        }

        // Fonction de déconnexion
        if (logoutBtn) {
            logoutBtn.addEventListener('click', function() {
                currentDriver = null;
                localStorage.removeItem('currentDriver');
                loginContainer.classList.remove('hidden');
                appContainer.classList.add('hidden');
                
                // Réinitialiser le formulaire de connexion
                if (loginForm) loginForm.reset();
                if (loginPassword) {
                    loginPassword.type = 'password';
                    if (togglePasswordBtn) togglePasswordBtn.innerHTML = '<i class="fas fa-eye"></i>';
                }
            });
        }

        // Fonction d'initialisation de l'application après connexion
        function initializeApp() {
            // Masquer l'écran de connexion, afficher l'application
            loginContainer.classList.add('hidden');
            appContainer.classList.remove('hidden');
            
            // Sauvegarder la session
            localStorage.setItem('currentDriver', JSON.stringify(currentDriver));
            
            // Mettre à jour les informations du conducteur
            document.getElementById('driver-name-display').textContent = currentDriver.name;
            document.getElementById('driver-service-display').textContent = 
                currentDriver.service + ' • ' + currentDriver.region + ', Togo';
            
            document.getElementById('driver-name').value = currentDriver.name;
            
            // Ajuster le prix par km selon le type de service
            switch(currentDriver.service) {
                case 'Moto Taxi':
                    pricePerKm = 150;
                    break;
                case 'Tricycle':
                    pricePerKm = 300;
                    break;
                case 'Taxi Bagage':
                    pricePerKm = 500;
                    break;
                case 'Transport Commun':
                    pricePerKm = 200;
                    break;
            }
            
            document.getElementById('price-per-km').value = pricePerKm;
            document.getElementById('service-type').value = currentDriver.service.toLowerCase();
            
            // Initialiser les événements de l'application
            initAppEvents();
            
            // Charger les reçus sauvegardés
            displaySavedReceipts();
            
            // Mettre à jour la date et l'heure
            updateDate();
            updateServerTime();
            setInterval(updateServerTime, 1000);
        }

        // Fonction pour calculer la distance entre deux points GPS (formule de Haversine)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371; // Rayon de la Terre en km
            const dLat = (lat2 - lat1) * Math.PI / 180;
            const dLon = (lon2 - lon1) * Math.PI / 180;
            const a = 
                Math.sin(dLat/2) * Math.sin(dLat/2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) * 
                Math.sin(dLon/2) * Math.sin(dLon/2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
            return R * c; // Distance en km
        }

        // Ouvrir Google Maps pour la navigation
        function openGoogleMapsNavigation() {
            const endAddress = document.getElementById('end-address').value;
            if (!endAddress) {
                alert('Veuillez saisir une adresse de destination');
                return;
            }
            
            const encodedEnd = encodeURIComponent(endAddress);
            const gmapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodedEnd}&travelmode=driving&dir_action=navigate`;
            window.open(gmapsUrl, '_blank');
            
            addHistoryEntry('Navigation Google Maps démarrée vers: ' + endAddress);
        }

        // Démarrage de la surveillance GPS
        function startGPSTracking() {
            if (navigator.geolocation) {
                const gpsStatus = document.getElementById('gps-status');
                if (gpsStatus) {
                    gpsStatus.textContent = "Connexion GPS en cours...";
                    gpsStatus.className = "gps-status gps-waiting";
                }
                
                const options = {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                };
                
                watchId = navigator.geolocation.watchPosition(
                    updatePosition,
                    handleLocationError,
                    options
                );
                
            } else {
                alert("La géolocalisation n'est pas supportée par votre navigateur.");
            }
        }

        // Mise à jour de la position
        function updatePosition(position) {
            currentPosition = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy,
                timestamp: position.timestamp
            };
            
            // Mettre à jour l'affichage GPS
            const gpsStatus = document.getElementById('gps-status');
            if (gpsStatus) {
                gpsStatus.textContent = "GPS: Actif (Précision: ±" + Math.round(currentPosition.accuracy) + "m)";
                gpsStatus.className = "gps-status gps-active";
            }
            
            // Mettre à jour l'adresse de départ
            document.getElementById('start-address').value = 
                `GPS: ${currentPosition.lat.toFixed(6)}, ${currentPosition.lng.toFixed(6)}`;
            
            // Stocker la position dans l'historique
            positionsHistory.push({
                ...currentPosition,
                time: new Date().toLocaleTimeString('fr-FR')
            });
            
            // Calculer la distance parcourue depuis la dernière position
            if (previousPosition && tripStarted && !tripPaused) {
                const distance = calculateDistance(
                    previousPosition.lat, previousPosition.lng,
                    currentPosition.lat, currentPosition.lng
                );
                
                // Ne prendre en compte que les distances réalistes
                if (distance < 1.0) {
                    totalDistance += distance;
                    updateDistanceDisplay();
                }
            }
            
            previousPosition = {...currentPosition};
        }

        // Gestion des erreurs de géolocalisation
        function handleLocationError(error) {
            const gpsStatus = document.getElementById('gps-status');
            if (gpsStatus) {
                gpsStatus.textContent = "GPS: Erreur de connexion";
                gpsStatus.className = "gps-status gps-inactive";
            }
            console.error('Erreur GPS:', error);
        }

        // Mise à jour de l'affichage de la distance
        function updateDistanceDisplay() {
            document.getElementById('distance-traveled').textContent = totalDistance.toFixed(2) + ' km';
            document.getElementById('distance-progress').textContent = 'sur ' + estimatedDistance.toFixed(2) + ' km';
            
            // Calculer le tarif actuel
            const currentFare = Math.round(totalDistance * pricePerKm);
            document.getElementById('current-fare').textContent = currentFare.toLocaleString('fr-FR') + ' FCFA';
            
            // Mettre à jour la vitesse moyenne
            if (elapsedSeconds > 0) {
                const averageSpeed = (totalDistance / (elapsedSeconds / 3600)).toFixed(1);
                document.getElementById('average-speed').textContent = averageSpeed + ' km/h';
            }
        }

        // Estimation de distance basée sur la destination
        function estimateDistance() {
            const endAddress = document.getElementById('end-address').value.toLowerCase();
            
            if (endAddress.includes('université') || endAddress.includes('universite')) {
                return 7.2;
            } else if (endAddress.includes('aéroport') || endAddress.includes('aeroport')) {
                return 12.5;
            } else if (endAddress.includes('marché') || endAddress.includes('marche')) {
                return 3.8;
            } else if (endAddress.includes('stade')) {
                return 5.2;
            } else if (endAddress.includes('gare')) {
                return 4.5;
            } else {
                return 5.0;
            }
        }

        // Démarrage du trajet
        function startTrip() {
            if (!tripStarted) {
                const clientName = document.getElementById('client-name').value;
                const clientPhone = document.getElementById('client-phone').value;
                const endAddress = document.getElementById('end-address').value;
                
                if (!clientName || !clientPhone || !endAddress) {
                    alert('Veuillez remplir tous les champs obligatoires');
                    return;
                }
                
                tripStarted = true;
                startTime = new Date();
                document.getElementById('start-time').textContent = startTime.toLocaleTimeString('fr-FR', {hour: '2-digit', minute:'2-digit'});
                
                // Estimer la distance
                estimatedDistance = estimateDistance();
                document.getElementById('estimated-distance').textContent = estimatedDistance.toFixed(2) + ' km';
                document.getElementById('distance-progress').textContent = 'sur ' + estimatedDistance.toFixed(2) + ' km';
                
                // Démarrer le chronomètre
                timerInterval = setInterval(updateTimer, 1000);
                
                // Démarrer le suivi GPS
                startGPSTracking();
                
                // Mettre à jour l'interface
                document.getElementById('start-btn').disabled = true;
                document.getElementById('pause-btn').disabled = false;
                document.getElementById('end-btn').disabled = false;
                
                addHistoryEntry('Trajet démarré avec Google Maps');
                addHistoryEntry('Distance estimée: ' + estimatedDistance.toFixed(2) + ' km');
            }
        }

        // Mise à jour du chronomètre
        function updateTimer() {
            if (!tripPaused) {
                elapsedSeconds++;
                const timeString = formatTime(elapsedSeconds);
                document.getElementById('elapsed-time').textContent = timeString;
                document.getElementById('elapsed-time-display').textContent = timeString;
                
                // Mettre à jour l'affichage toutes les 5 secondes
                if (elapsedSeconds % 5 === 0) {
                    updateDistanceDisplay();
                }
            }
        }

        // Formatage du temps écoulé
        function formatTime(seconds) {
            const hrs = Math.floor(seconds / 3600);
            const mins = Math.floor((seconds % 3600) / 60);
            const secs = seconds % 60;
            
            return `${hrs.toString().padStart(2, '0')}:${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        // Mettre en pause/reprendre le trajet
        function togglePause() {
            tripPaused = !tripPaused;
            document.getElementById('pause-btn').innerHTML = tripPaused ? 
                '<i class="fas fa-play"></i> Reprendre' : 
                '<i class="fas fa-pause"></i> Pause';
            
            document.getElementById('trip-status').textContent = tripPaused ? 'PAUSE' : 'ACTIF';
            document.getElementById('trip-status').className = tripPaused ? 
                'trip-status status-paused' : 'trip-status status-active';
                
            if (tripPaused) {
                addHistoryEntry('Trajet mis en pause');
            } else {
                addHistoryEntry('Trajet repris');
            }
        }

        // Arriver à destination et générer le reçu
        function arriveAtDestination() {
            if (tripStarted) {
                tripStarted = false;
                clearInterval(timerInterval);
                
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
                
                // Mettre à jour l'interface
                document.getElementById('start-btn').disabled = false;
                document.getElementById('pause-btn').disabled = true;
                document.getElementById('end-btn').disabled = true;
                document.getElementById('trip-status').textContent = 'TERMINÉ';
                document.getElementById('trip-status').className = 'trip-status status-finished';
                
                // S'assurer que la distance est correctement calculée
                if (totalDistance === 0 && positionsHistory.length > 1) {
                    let calculatedDistance = 0;
                    for (let i = 1; i < positionsHistory.length; i++) {
                        const dist = calculateDistance(
                            positionsHistory[i-1].lat, positionsHistory[i-1].lng,
                            positionsHistory[i].lat, positionsHistory[i].lng
                        );
                        if (dist < 1.0) {
                            calculatedDistance += dist;
                        }
                    }
                    totalDistance = calculatedDistance;
                }
                
                // Générer le reçu
                generateReceipt();
                
                // Afficher la section de paiement
                document.getElementById('payment-section').classList.remove('hidden');
                
                addHistoryEntry('Destination atteinte');
                addHistoryEntry('Distance finale parcourue: ' + totalDistance.toFixed(2) + ' km');
            }
        }

        // Générer le reçu de paiement
        function generateReceipt() {
            const driverName = document.getElementById('driver-name').value;
            const clientName = document.getElementById('client-name').value;
            const clientPhone = document.getElementById('client-phone').value;
            const serviceType = document.getElementById('service-type').options[document.getElementById('service-type').selectedIndex].text;
            const endAddress = document.getElementById('end-address').value;
            
            // Calculer le tarif final
            const baseFare = Math.round(totalDistance * pricePerKm);
            const totalFare = baseFare + extraFees;
            
            // Mettre à jour le reçu
            document.getElementById('receipt-driver').textContent = driverName;
            document.getElementById('receipt-client').textContent = clientName;
            document.getElementById('receipt-service').textContent = serviceType;
            document.getElementById('receipt-date').textContent = document.getElementById('current-date').textContent;
            document.getElementById('receipt-start').textContent = 'Position GPS';
            document.getElementById('receipt-end').textContent = endAddress;
            document.getElementById('receipt-distance').textContent = totalDistance.toFixed(2) + ' km';
            document.getElementById('receipt-duration').textContent = document.getElementById('elapsed-time').textContent;
            document.getElementById('receipt-base-fare').textContent = baseFare.toLocaleString('fr-FR') + ' FCFA';
            document.getElementById('receipt-extra-fees').textContent = extraFees.toLocaleString('fr-FR') + ' FCFA';
            document.getElementById('receipt-total').textContent = totalFare.toLocaleString('fr-FR') + ' FCFA';
            document.getElementById('price-per-km-display').textContent = pricePerKm + ' FCFA/km';
            
            // Sauvegarder le reçu
            saveReceipt({
                id: Date.now(),
                driverId: currentDriver.id,
                driverName,
                clientName,
                clientPhone,
                serviceType,
                startAddress: 'Position GPS',
                endAddress,
                distance: totalDistance,
                duration: document.getElementById('elapsed-time').textContent,
                baseFare,
                extraFees,
                totalFare,
                date: new Date().toISOString().split('T')[0],
                region: getRegionFromAddress(endAddress),
                locality: getLocalityFromAddress(endAddress)
            });
        }

        // Sauvegarder le reçu
        function saveReceipt(receipt) {
            savedReceipts.unshift(receipt);
            if (savedReceipts.length > 100) {
                savedReceipts = savedReceipts.slice(0, 100);
            }
            localStorage.setItem('savedReceipts', JSON.stringify(savedReceipts));
            displaySavedReceipts();
        }

        // Afficher les reçus sauvegardés
        function displaySavedReceipts() {
            const receiptsGrid = document.getElementById('receipts-grid');
            if (!receiptsGrid) return;
            
            receiptsGrid.innerHTML = '';
            
            // Filtrer les reçus du conducteur connecté
            const driverReceipts = savedReceipts.filter(receipt => receipt.driverId === currentDriver.id);
            
            const monthFilter = document.getElementById('filter-month').value || 'all';
            const regionFilter = document.getElementById('filter-region').value || 'all';
            const localityFilter = document.getElementById('filter-locality').value || 'all';
            
            const filteredReceipts = driverReceipts.filter(receipt => {
                const receiptMonth = receipt.date.split('-')[1];
                const matchesMonth = monthFilter === 'all' || receiptMonth === monthFilter;
                const matchesRegion = regionFilter === 'all' || receipt.region === regionFilter;
                const matchesLocality = localityFilter === 'all' || receipt.locality === localityFilter;
                
                return matchesMonth && matchesRegion && matchesLocality;
            });
            
            if (filteredReceipts.length === 0) {
                receiptsGrid.innerHTML = '<p>Aucun reçu trouvé pour les critères sélectionnés.</p>';
                return;
            }
            
            filteredReceipts.forEach(receipt => {
                const receiptCard = document.createElement('div');
                receiptCard.className = 'receipt-card';
                
                const date = new Date(receipt.date).toLocaleDateString('fr-FR');
                
                receiptCard.innerHTML = `
                    <div class="receipt-card-header">
                        <span class="receipt-card-date">${date}</span>
                        <span class="receipt-card-amount">${receipt.totalFare.toLocaleString('fr-FR')} FCFA</span>
                    </div>
                    <div class="receipt-card-details">
                        <div><strong>Client:</strong> ${receipt.clientName}</div>
                        <div><strong>Service:</strong> ${receipt.serviceType}</div>
                        <div><strong>Trajet:</strong> ${receipt.startAddress} → ${receipt.endAddress}</div>
                        <div><strong>Distance:</strong> ${receipt.distance.toFixed(2)} km</div>
                        <div><strong>Durée:</strong> ${receipt.duration}</div>
                    </div>
                `;
                
                receiptsGrid.appendChild(receiptCard);
            });
        }

        // Obtenir la région depuis l'adresse
        function getRegionFromAddress(address) {
            if (address.includes('Lomé') || address.includes('Aného') || address.includes('Tsévié')) {
                return 'maritime';
            } else if (address.includes('Kpalimé') || address.includes('Atakpamé')) {
                return 'plateaux';
            } else if (address.includes('Sokodé') || address.includes('Bafilo')) {
                return 'centrale';
            } else if (address.includes('Kara') || address.includes('Niamtougou')) {
                return 'kara';
            } else if (address.includes('Dapaong') || address.includes('Mango')) {
                return 'savanes';
            }
            return 'inconnue';
        }

        // Obtenir la localité depuis l'adresse
        function getLocalityFromAddress(address) {
            if (address.includes('Lomé')) return 'lome';
            if (address.includes('Kpalimé')) return 'kpalime';
            if (address.includes('Sokodé')) return 'sokode';
            if (address.includes('Kara')) return 'kara';
            if (address.includes('Dapaong')) return 'dapaong';
            return 'autre';
        }

        // Mise à jour de la date
        function updateDate() {
            const now = new Date();
            const options = { day: 'numeric', month: 'short', year: 'numeric' };
            document.getElementById('current-date').textContent = now.toLocaleDateString('fr-FR', options);
        }

        // Mise à jour de l'heure serveur
        function updateServerTime() {
            const now = new Date();
            const serverTimeElement = document.getElementById('server-time');
            if (serverTimeElement) {
                serverTimeElement.textContent = now.toLocaleTimeString('fr-FR');
            }
        }

        // Ajouter une entrée à l'historique
        function addHistoryEntry(action) {
            const now = new Date();
            const timeString = now.toLocaleTimeString('fr-FR');
            
            const historyItem = document.createElement('div');
            historyItem.className = 'history-item';
            historyItem.innerHTML = `
                <span class="history-time">${timeString}</span>
                <span class="history-action">${action}</span>
            `;
            
            const tripHistory = document.getElementById('trip-history');
            if (tripHistory) {
                tripHistory.prepend(historyItem);
            }
        }

        // Initialisation des événements de l'application
        function initAppEvents() {
            // Événement pour démarrer le trajet
            document.getElementById('start-trip-btn').addEventListener('click', function() {
                const clientName = document.getElementById('client-name').value;
                const clientPhone = document.getElementById('client-phone').value;
                const endAddress = document.getElementById('end-address').value;
                
                // Validation
                if (!clientName || !clientPhone || !endAddress) {
                    alert('Veuillez remplir tous les champs obligatoires');
                    return;
                }
                
                // Mettre à jour l'affichage
                document.getElementById('client-name-display').textContent = clientName;
                document.getElementById('client-phone-display').textContent = clientPhone;
                document.getElementById('service-type-display').textContent = 
                    document.getElementById('service-type').options[document.getElementById('service-type').selectedIndex].text;
                document.getElementById('end-address-display').textContent = endAddress;
                document.getElementById('price-per-km-display').textContent = pricePerKm + ' FCFA/km';
                
                // Afficher les sections du trajet
                document.getElementById('setup-form').classList.add('hidden');
                document.getElementById('trip-card').classList.remove('hidden');
                document.getElementById('tracking-section').classList.remove('hidden');
                document.getElementById('history-section').classList.remove('hidden');
                
                // Ouvrir Google Maps automatiquement
                setTimeout(openGoogleMapsNavigation, 500);
            });

            // Événements des boutons de navigation
            document.getElementById('open-gmaps-navigation').addEventListener('click', openGoogleMapsNavigation);
            
            document.getElementById('share-location-btn').addEventListener('click', function() {
                if (currentPosition) {
                    const message = `📍 Ma position actuelle: https://maps.google.com/?q=${currentPosition.lat},${currentPosition.lng}`;
                    const phone = document.getElementById('client-phone').value.replace(/\D/g, '');
                    const whatsappUrl = `https://wa.me/${phone}?text=${encodeURIComponent(message)}`;
                    window.open(whatsappUrl, '_blank');
                    addHistoryEntry('Position partagée avec le client via WhatsApp');
                } else {
                    alert("Position non disponible. Attendez que le GPS se connecte.");
                }
            });

            // Événements des contrôles de trajet
            document.getElementById('start-btn').addEventListener('click', startTrip);
            document.getElementById('pause-btn').addEventListener('click', togglePause);
            document.getElementById('end-btn').addEventListener('click', arriveAtDestination);

            // Événements de paiement
            document.getElementById('payment-received-btn').addEventListener('click', function() {
                const totalFare = document.getElementById('receipt-total').textContent;
                alert('Paiement de ' + totalFare + ' confirmé! Merci pour votre service.');
                addHistoryEntry('Paiement reçu et confirmé');
                document.getElementById('receipts-section').classList.remove('hidden');
            });

            document.getElementById('send-whatsapp-btn').addEventListener('click', function() {
                const clientPhone = document.getElementById('client-phone').value.replace(/\D/g, '');
                const totalFare = document.getElementById('receipt-total').textContent;
                const clientName = document.getElementById('client-name').value;
                const distance = document.getElementById('receipt-distance').textContent;
                const duration = document.getElementById('receipt-duration').textContent;
                
                const message = `Bonjour ${clientName},\n\nVotre reçu de transport :\n• Distance: ${distance}\n• Durée: ${duration}\n• Montant: ${totalFare}\n\nMerci pour votre confiance! 🚕`;
                const whatsappUrl = `https://wa.me/${clientPhone}?text=${encodeURIComponent(message)}`;
                window.open(whatsappUrl, '_blank');
                addHistoryEntry('Reçu envoyé par WhatsApp au client');
            });

            document.getElementById('new-trip-btn').addEventListener('click', function() {
                // Réinitialiser les variables
                totalDistance = 0;
                tripStarted = false;
                tripPaused = false;
                elapsedSeconds = 0;
                positionsHistory = [];
                currentPosition = null;
                previousPosition = null;
                estimatedDistance = 0;
                
                if (timerInterval) clearInterval(timerInterval);
                if (watchId) {
                    navigator.geolocation.clearWatch(watchId);
                    watchId = null;
                }
                
                // Réinitialiser l'interface
                document.getElementById('distance-traveled').textContent = '0.0 km';
                document.getElementById('current-fare').textContent = '0 FCFA';
                document.getElementById('elapsed-time').textContent = '00:00:00';
                document.getElementById('elapsed-time-display').textContent = '00:00:00';
                document.getElementById('average-speed').textContent = '0 km/h';
                document.getElementById('estimated-distance').textContent = '-- km';
                document.getElementById('distance-progress').textContent = 'sur 0.0 km';
                document.getElementById('start-address').value = 'Position GPS';
                
                // Cacher les sections, afficher le formulaire
                document.getElementById('trip-card').classList.add('hidden');
                document.getElementById('tracking-section').classList.add('hidden');
                document.getElementById('payment-section').classList.add('hidden');
                document.getElementById('receipts-section').classList.add('hidden');
                document.getElementById('history-section').classList.add('hidden');
                document.getElementById('setup-form').classList.remove('hidden');
                
                addHistoryEntry('Nouveau trajet préparé');
            });

            // Événements des filtres
            document.getElementById('filter-month').addEventListener('change', displaySavedReceipts);
            document.getElementById('filter-region').addEventListener('change', displaySavedReceipts);
            document.getElementById('filter-locality').addEventListener('change', displaySavedReceipts);

            // Événement pour le bouton d'impression
            document.getElementById('print-receipt-btn').addEventListener('click', function() {
                window.print();
            });
        }

        // Initialisation au chargement de la page
        document.addEventListener('DOMContentLoaded', function() {
            // Vérifier s'il y a une session active
            const savedDriver = localStorage.getItem('currentDriver');
            if (savedDriver) {
                try {
                    const driver = JSON.parse(savedDriver);
                    if (driversDatabase[driver.id] && driversDatabase[driver.id].isActive) {
                        currentDriver = driver;
                        initializeApp();
                    }
                } catch (e) {
                    console.error('Erreur de parsing de la session:', e);
                    localStorage.removeItem('currentDriver');
                }
            }
        });
    </script>
</body>
</html>
